# Week 12 作业：命令行习惯追踪器

本周你学会了用 argparse 写专业的 CLI 工具。现在，把这套技能用到一个真实场景：**命令行习惯追踪器**（habit-cli）。

为什么选"习惯追踪"？
- 它和待办事项（todo-cli）有相似的结构，但业务逻辑不同——练习你的迁移能力
- 习惯追踪需要记录"打卡历史"，自然引出日志和持久化
- 你真的可以用这个工具追踪自己的学习习惯

---

## 作业背景

小北想养成"每天学 Python"的习惯，但她总是忘记自己坚持了几天。于是她想写一个命令行工具来追踪习惯：

```bash
# 添加习惯
habit add "每天学 Python 30 分钟"

# 打卡
habit checkin "每天学 Python 30 分钟"

# 查看所有习惯
habit list

# 查看某个习惯的打卡记录
habit log "每天学 Python 30 分钟"

# 删除习惯
habit delete "每天学 Python 30 分钟"
```

你的任务：**实现一个完整的 habit-cli 工具**，支持上述功能。

---

## 基础题（必做）：argparse 基础与子命令

### 功能要求

1. **`add` 子命令**：添加新习惯
   - 位置参数：习惯名称（必需）
   - 可选参数：`--description`（描述文本）

2. **`list` 子命令**：列出所有习惯
   - 可选参数：`--active`（只显示活跃习惯）

3. **`checkin` 子命令**：记录一次打卡
   - 位置参数：习惯名称（必需）

### 数据存储

- 用简单的 JSON 文件存储数据（`habits.json`）
- 数据结构（参考）：

```json
{
  "habits": [
    {
      "name": "每天学 Python 30 分钟",
      "description": "Week 01-12 系统学习",
      "created_at": "2026-02-09",
      "active": true,
      "checkins": ["2026-02-09", "2026-02-10"]
    }
  ]
}
```

### 输入输出示例

```bash
# 添加习惯
$ habit add "每天学 Python 30 分钟" --description "Week 01-12 系统学习"
✓ 习惯已添加：每天学 Python 30 分钟

# 列出习惯
$ habit list
习惯列表：
1. 每天学 Python 30 分钟 - Week 01-12 系统学习
   创建时间：2026-02-09 | 活跃：是 | 打卡次数：0

# 打卡
$ habit checkin "每天学 Python 30 分钟"
✓ 打卡成功：每天学 Python 30 分钟

# 再次列出（看到打卡次数更新）
$ habit list
习惯列表：
1. 每天学 Python 30 分钟 - Week 01-12 系统学习
   创建时间：2026-02-09 | 活跃：是 | 打卡次数：1
```

### 提示与常见错误

**提示**：
- 先在纸上画出子命令结构，再动手写代码
- 用 `add_parser.set_defaults(func=cmd_xxx)` 路由到函数
- 每个子命令函数返回退出码（0 成功，1 失败）

**常见错误**：
- **忘记处理空输入**：用户可能传空字符串 `" "`，记得检查 `strip()`
- **JSON 文件不存在**：第一次运行时 `habits.json` 还不存在，要自动创建
- **习惯名称重复**：添加习惯前检查是否已存在
- **打卡不存在的习惯**：要返回错误退出码 1，并输出到 stderr

### 自测检查点

- [ ] `habit add "读书"` 能添加习惯
- [ ] `habit list --active` 能列出活跃习惯
- [ ] `habit checkin "读书"` 能记录打卡
- [ ] 重复添加同名习惯时报错
- [ ] 不存在的习惯打卡时返回退出码 1

---

## 进阶题（必做）：退出码 + 子命令扩展 + 日志

### 功能扩展

4. **`log` 子命令**：查看某个习惯的打卡历史
   - 位置参数：习惯名称（必需）

5. **`delete` 子命令**：删除习惯
   - 位置参数：习惯名称（必需）

6. **退出码**：
   - 所有子命令正确返回退出码（0 成功，1 失败）
   - 错误消息输出到 stderr

7. **日志记录**：
   - 用 `logging` 模块记录所有操作到 `habit.log`
   - 日志格式：`时间 - 级别 - 消息`

### 输入输出示例

```bash
# 查看打卡历史
$ habit log "每天学 Python 30 分钟"
打卡记录：
2026-02-09
2026-02-10
2026-02-11

# 删除习惯
$ habit delete "每天学 Python 30 分钟"
✓ 习惯已删除：每天学 Python 30 分钟

# 查看日志文件
$ cat habit.log
2026-02-09 14:30:15,123 - INFO - 添加习惯：每天学 Python 30 分钟
2026-02-09 14:30:16,456 - INFO - 打卡成功：每天学 Python 30 分钟
2026-02-09 14:30:17,789 - WARNING - 习惯不存在：不存在的习惯
```

### 退出码测试

```bash
# 成功的情况
$ habit checkin "读书"
$ echo $?
0

# 失败的情况（习惯不存在）
$ habit checkin "不存在的习惯"
错误：习惯不存在
$ echo $?
1
```

### 提示与常见错误

**提示**：
- 用 `print(..., file=sys.stderr)` 输出错误消息
- 用 `sys.exit(exit_code)` 统一返回退出码
- 日志级别：INFO 记录正常操作，WARNING 记录可恢复的错误，ERROR 记录失败

**常见错误**：
- **错误消息输出到 stdout**：用户在脚本里捕获不到错误信息
- **忘记返回退出码**：Python 默认返回 0，脚本无法判断失败
- **日志级别滥用**：不要用 INFO 记录"习惯不存在"，应该用 WARNING 或 ERROR
- **覆盖 JSON 文件**：读文件时要处理 `FileNotFoundError`，不要直接覆盖

### 自测检查点

- [ ] `habit log "读书"` 能显示打卡历史
- [ ] `habit delete "读书"` 能删除习惯
- [ ] 所有子命令正确返回退出码
- [ ] `habit.log` 文件包含操作日志
- [ ] 错误消息输出到 stderr（不是 stdout）

---

## 挑战题（可选）：统计功能 + 高级特性

### 功能扩展

8. **`stats` 子命令**：显示习惯统计信息
   - 显示总习惯数、活跃习惯数、总打卡次数
   - 可选参数：`--json`（以 JSON 格式输出）

9. **全局参数**：`--verbose`（显示详细日志）

10. **额外功能**（选做一个）：
    - **打卡连胜**（streak）：计算当前连续打卡天数
    - **最佳连胜**（longest streak）：历史最长连续打卡
    - **`archive` 子命令**：归档习惯（不删除，但标记为不活跃）

### 输入输出示例

```bash
# 统计信息
$ habit stats
习惯统计：
总习惯数：3
活跃习惯：2
总打卡次数：15

# JSON 格式
$ habit stats --json
{
  "total_habits": 3,
  "active_habits": 2,
  "total_checkins": 15
}

# 详细模式
$ habit --verbose add "写日记"
DEBUG: 数据文件路径：/Users/xxx/.habit-cli/habits.json
INFO: 添加习惯：写日记
✓ 习惯已添加：写日记
```

### 提示

- 用 `json.dumps()` 输出 JSON 格式
- `--verbose` 参数应该在解析子命令前处理，调整日志级别
- 连胜计算：对打卡日期排序，找到当前连续的日期序列

---

## AI 协作练习（可选）

本周属于 **主导期**，你可以尝试用 AI 结对编程完成 habit-cli 的骨架代码。

### 任务描述

让 AI 工具（如 Claude、ChatGPT、GitHub Copilot）生成 habit-cli 的 argparse 骨架代码，要求：
- 包含所有子命令（add/list/checkin/log/delete/stats）
- 包含参数定义（位置参数、可选参数）
- 包含基本的函数框架

### 审查清单

拿到 AI 生成的代码后，你必须逐项检查：

- [ ] **代码能运行吗？**：试运行 `habit.py --help`，不会报错
- [ ] **子命令设计合理吗？**：
  - [ ] 子命令用动词命名（add/list/delete），不是名词
  - [ ] 参数符合直觉（`add` 的位置参数是习惯名称）
  - [ ] 帮助文档清晰（`habit add --help` 能看懂）
- [ ] **参数类型正确吗？**：
  - [ ] 位置参数和可选参数区分清楚
  - [ ] 必需参数用了 `required=True` 或直接用位置参数
  - [ ] 用了 `choices` 限制可选值（如 `--format json|csv`）
- [ ] **有退出码吗？**：每个命令函数都返回退出码
- [ ] **有错误处理吗？**：至少处理了 `FileNotFoundError`（JSON 文件不存在）
- [ ] **变量命名清晰吗？**：不是 `x`、`temp` 这种无意义名字
- [ ] **边界情况处理了吗？**：
  - [ ] 空输入（`""` 或 `"   "`）
  - [ ] 不存在的习惯
  - [ ] 重复添加同名习惯

### 发现的常见问题（参考）

AI 生成的代码经常有这些问题：

1. **缺少退出码**：命令函数没有返回值，或总是返回 0
2. **参数设计不合理**：把必需参数写成可选参数，或把位置参数写成 `--name` 这种形式
3. **没有错误处理**：直接 `open("habits.json")` 而不处理文件不存在的情况
4. **变量命名混乱**：用 `args_1`、`temp_data` 这种不清晰的名字
5. **帮助文档太简单**：`help="name"` 这种没用的描述
6. **子命令用名词**：`habit task` 而不是 `habit add`

### 提交物

1. **修复后的代码**：你根据审查清单修复后的完整 habit-cli
2. **审查报告**（简短）：
   - AI 生成的代码有哪些问题？
   - 你修复了哪些？
   - 你学到了什么？（关于 CLI 设计或 argparse 使用）

---

## 交付物清单

### 基础题

- [ ] `habit.py`：主程序文件，包含 argparse 和子命令
- [ ] `habits.json`：数据文件（自动生成）

### 进阶题

- [ ] 完整的子命令实现（add/list/checkin/log/delete）
- [ ] 正确的退出码处理
- [ ] `habit.log`：日志文件

### 挑战题（可选）

- [ ] `stats` 子命令
- [ ] `--verbose` 全局参数
- [ ] 额外功能（连胜/archive）

### AI 协作练习（可选）

- [ ] AI 生成的骨架代码（保存为 `habit_ai_generated.py`）
- [ ] 修复后的代码
- [ ] 审查报告（`ai_review.md`）

---

## 提示与资源

### 如果你遇到困难

1. **参考教材示例**：CHAPTER.md 中的 `todo-cli` 案例
2. **参考 PyHelper CLI**：`examples/pyhelper/cli.py`
3. **查看 argparse 文档**：`python3 -c "import argparse; help(argparse.ArgumentParser)"`

### 测试建议

- 用 pytest + subprocess 测试退出码（参考教材第 4 节）
- 手动测试每个子命令的各种参数组合
- 测试边界情况：空输入、不存在的习惯、重复操作

### 常见陷阱（别踩）

- **JSON 文件被覆盖**：每次写文件前先读取，不要直接 `dump` 覆盖
- **日期格式不一致**：用统一的日期格式（如 `YYYY-MM-DD`）
- **日志没有输出**：检查 `logging.basicConfig` 的 `filename` 参数
- **退出码在测试里不对**：`subprocess.run()` 的返回值在 `result.returncode`

---

## 最后提醒

- **不要抄袭参考实现**：你可以看教材示例，但代码必须自己写
- **先跑通，再优化**：能用的"丑代码"比不能用的"美代码"有用
- **提交前自测**：运行一遍所有子命令，确保不会在演示时翻车
- **Git 提交**：至少 2 次提交（draft + verify）

祝你写出属于自己的习惯追踪器！
